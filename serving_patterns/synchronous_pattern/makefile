DOCKER_REPOSITORY := tjems6498/ml-system-in-actions

ABSOLUTE_PATH := $(shell pwd)

DOCKERFILE := Dockerfile
IMAGE_VERSION := 0.0.1

SYNCHRONOUS_PATTERN := synchronous_pattern
SYNCHRONOUS_PATTERN_SERVER := imagenet_inception_v3
SYNCHRONOUS_PATTERN_GRPC_PORT := 8500
SYNCHRONOUS_PATTERN_REST_PORT := 8501


.PHONY: build
build:
	docker build \
		--network=host \
		-t $(DOCKER_REPOSITORY):$(SYNCHRONOUS_PATTERN)_$(SYNCHRONOUS_PATTERN_SERVER)_$(IMAGE_VERSION) \
		-f $(SYNCHRONOUS_PATTERN_SERVER)/$(DOCKERFILE) .

.PHONY: run
run:
	docker run \
		-d \
		--name $(SYNCHRONOUS_PATTERN_SERVER) \
		-p $(SYNCHRONOUS_PATTERN_GRPC_PORT):$(SYNCHRONOUS_PATTERN_GRPC_PORT) \
		-p $(SYNCHRONOUS_PATTERN_REST_PORT):$(SYNCHRONOUS_PATTERN_REST_PORT) \
		$(DOCKER_REPOSITORY):$(SYNCHRONOUS_PATTERN)_$(SYNCHRONOUS_PATTERN_SERVER)_$(IMAGE_VERSION)

.PHONY: stop
stop:
	docker rm -f $(SYNCHRONOUS_PATTERN_SERVER)

.PHONY: push
push:
	docker push $(DOCKER_REPOSITORY):$(SYNCHRONOUS_PATTERN)_$(SYNCHRONOUS_PATTERN_SERVER)_$(IMAGE_VERSION)

.PHONY: pull
pull:
	docker pull $(DOCKER_REPOSITORY):$(SYNCHRONOUS_PATTERN)_$(SYNCHRONOUS_PATTERN_SERVER)_$(IMAGE_VERSION)

.PHONY: build_all
build_all: build

.PHONY: run_all
run_all: run

.PHONY: push_all
push_all: push
